{% extends 'dashboard/base.html' %}
{% block title %}All Company Meetings{% endblock %}
{% load static %}
{% block content %}

<h4 class="mb-3">üè¢ Company Meetings Filter</h4>

<form method="get" class="mb-4 bg-light p-3 rounded shadow-sm">
  <div class="row g-2 align-items-end">

    <!-- FROM DATE -->
    <div class="col-md-2 col-6">
      <label class="small fw-bold">From Date</label>
      <input type="date" name="date_from" class="form-control form-control-sm"
             value="{{ request.GET.date_from }}">
    </div>

    <!-- TO DATE -->
    <div class="col-md-2 col-6">
      <label class="small fw-bold">To Date</label>
      <input type="date" name="date_to" class="form-control form-control-sm"
             value="{{ request.GET.date_to }}">
    </div>

    <!-- CITY -->
    <div class="col-md-2 col-6 filter-field">
      <label class="small fw-bold">City</label>
      <div class="jet-filter">
        <input type="text" class="jet-input" id="cityFilter" placeholder="Type or select city">
        <div class="jet-dropdown" id="cityDropdown">
          <div class="jet-option" data-value="">All</div>
          {% for city in cities %}
            <div class="jet-option" data-value="{{ city.id }}">{{ city }}</div>
          {% endfor %}
        </div>
      </div>
      <input type="hidden" name="city" id="cityHidden" value="{{ request.GET.city }}">
    </div>

    <!-- LOCALITY -->
    <div class="col-md-2 col-6 filter-field">
      <label class="small fw-bold">Locality</label>
      <div class="jet-filter">
        <input type="text" class="jet-input" id="localityFilter" placeholder="Type or select locality">
        <div class="jet-dropdown" id="localityDropdown">
          <div class="jet-option" data-value="">All</div>
          {% for l in localities %}
            <div class="jet-option" data-value="{{ l.id }}">{{ l }}</div>
          {% endfor %}
        </div>
      </div>
      <input type="hidden" name="locality" id="localityHidden" value="{{ request.GET.locality }}">
    </div>

    <!-- MEETING STATUS -->
    <div class="col-md-2 col-6 filter-field">
      <label class="small fw-bold">Meeting Status</label>
      <div class="jet-filter">
        <input type="text" class="jet-input" id="statusFilter" placeholder="Type or select status">
        <div class="jet-dropdown" id="statusDropdown">
          <div class="jet-option" data-value="">All</div>
          {% for s in statuses %}
            <div class="jet-option" data-value="{{ s }}">{{ s }}</div>
          {% endfor %}
        </div>
      </div>
      <input type="hidden" name="status" id="statusHidden" value="{{ request.GET.status }}">
    </div>

    <!-- ASSIGNED TO -->
    <div class="col-md-2 col-6 filter-field">
      <label class="small fw-bold">Assigned To</label>
      <div class="jet-filter">
        <input type="text" class="jet-input" id="assignedFilter" placeholder="Type or select staff">
        <div class="jet-dropdown" id="assignedDropdown">
          <div class="jet-option" data-value="">All</div>
          {% for s in staff_list %}
            <div class="jet-option" data-value="{{ s.id }}">{{ s }}</div>
          {% endfor %}
        </div>
      </div>
      <input type="hidden" name="assigned_to" id="assignedHidden" value="{{ request.GET.assigned_to }}">
    </div>

    <!-- CATEGORY -->
    <div class="col-md-2 col-6 filter-field">
      <label class="small fw-bold">Category</label>
      <div class="jet-filter">
        <input type="text" class="jet-input" id="categoryFilter" placeholder="Type or select category">
        <div class="jet-dropdown" id="categoryDropdown">
          <div class="jet-option" data-value="">All</div>
          {% for c in categories %}
            <div class="jet-option" data-value="{{ c.id }}">{{ c }}</div>
          {% endfor %}
        </div>
      </div>
      <input type="hidden" name="category" id="categoryHidden" value="{{ request.GET.category }}">
    </div>

    <!-- FILTER BUTTON -->
    <div class="col-md-2 col-12 mt-2 mt-md-0">
      <button type="submit" class="btn btn-sm btn-primary w-100">
        <i class="fas fa-filter me-1"></i> Filter
      </button>
    </div>

    <!-- RESET BUTTON -->
    <div class="col-md-2 col-12 mt-2 mt-md-0">
      <a href="{% url 'company_meetings' %}" class="btn btn-sm btn-secondary w-100">
        <i class="fas fa-undo me-1"></i> Reset
      </a>
    </div>

  </div>
</form>



<script>
function jetFilter(inputId, dropdownId, hiddenId) {
  const input = document.getElementById(inputId);
  const dropdown = document.getElementById(dropdownId);
  const hidden = document.getElementById(hiddenId);

  input.addEventListener('focus', () => dropdown.style.display = 'block');
  input.addEventListener('blur', () => {
    setTimeout(() => dropdown.style.display = 'none', 200);
  });

  input.addEventListener('keyup', () => {
    const val = input.value.toLowerCase();
    dropdown.querySelectorAll('.jet-option').forEach(opt => {
      opt.style.display = opt.textContent.toLowerCase().includes(val) ? 'block' : 'none';
    });
  });

  dropdown.querySelectorAll('.jet-option').forEach(opt => {
    opt.addEventListener('click', () => {
      input.value = opt.textContent;
      hidden.value = opt.dataset.value;
      dropdown.style.display = 'none';
    });
  });
}

jetFilter('cityFilter', 'cityDropdown', 'cityHidden');
jetFilter('localityFilter', 'localityDropdown', 'localityHidden');
jetFilter('statusFilter', 'statusDropdown', 'statusHidden');
jetFilter('assignedFilter', 'assignedDropdown', 'assignedHidden');
jetFilter('categoryFilter', 'categoryDropdown', 'categoryHidden');
</script>


<h5 class="mb-3">üóì Total {{ page_obj.paginator.count }} Meetings</h5>

<!-- üñ•Ô∏è DESKTOP TABLE VIEW -->
<div class="table-responsive d-none d-md-block">
  <table class="table table-bordered table-hover table-sm align-middle">
    <thead class="thead-dark">
      <tr>
        <th>ID</th>
        <th>Meeting Details</th>
        <th>Company Details</th>
        <th>Assigned To</th>
        <th>Created / Updated</th>
        <th class="text-center">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for m in meetings %}
      <tr>
        <td><strong>#{{ m.id }}</strong></td>

        <!-- üóì MEETING DETAILS -->
        <td style="min-width:250px;">
          <div class="small">
            <strong>Status:</strong> {{ m.status|default:"-" }}<br>
            {% if m.meeting_date %}
              <strong>Meeting Date:</strong> {{ m.meeting_date|date:"d M Y H:i" }}<br>
            {% endif %}
            {% if m.comment %}
              <strong>Comment:</strong> {{ m.comment|default:"-" }}<br>
            {% endif %}
          </div>
        </td>

        <!-- üè¢ COMPANY DETAILS -->
        <td style="min-width:350px;">
          <div class="border rounded bg-light p-2 small">
            <strong>Company ID:</strong> BC{{ m.company.id|stringformat:"03d" }}<br>
            <strong>Name:</strong> {{ m.company.company_name|default:"-" }}<br>
            <strong>Status:</strong> {{ m.company.status|default:"-" }}<br>
            <strong>Category:</strong> {{ m.company.category|default:"-" }}<br>
            <strong>Person:</strong> {{ m.company.contact_person|default:"-" }}<br>
            <strong>Phone:</strong> {{ m.company.contact_no|default:"-" }}<br>
            <strong>City:</strong> {{ m.company.city|default:"-" }}<br>
            <strong>Locality:</strong> {{ m.company.locality|default:"-" }}<br>
            <strong>Address:</strong> {{ m.company.address|default:"-" }}<br>
            <strong>Assigned:</strong> {{ m.company.assigned_to|default:"-" }}<br>
            <strong>Created By:</strong> {{ m.company.created_by|default:"-" }}<br>
            <strong>Created On:</strong> {{ m.company.create_at|date:"d M Y H:i" }}
          </div>
        </td>

        <!-- üë§ ASSIGNED -->
        <td>
          {% if m.assigned_to %}
            {{ m.assigned_to }}
          {% else %}
            -
          {% endif %}
        </td>

        <!-- üïì CREATED / UPDATED -->
        <td class="small text-muted">
          {% if m.created_by %}
            <strong>{{ m.created_by }}</strong><br>
            <span>{{ m.create_at|date:"d M Y H:i" }}</span><br>
          {% endif %}
          {% if m.updated_by %}
            <strong>{{ m.updated_by }}</strong><br>
            <span>{{ m.update_at|date:"d M Y H:i" }}</span>
          {% endif %}
        </td>

        <!-- ‚úèÔ∏è ACTION BUTTON -->
        <td class="text-center">
          <a href="{% url 'edit_company_meeting' m.id %}" 
             class="btn btn-sm btn-outline-primary">
            <i class="fas fa-edit"></i> Edit
          </a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="text-center text-muted">No meetings found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- üì± MOBILE CARD VIEW -->
<div class="d-md-none">
  {% for m in meetings %}
  <div class="card mb-3 shadow-sm border-0 rounded-3" style="background:#f9f9f9;">
    <div class="card-body p-3 small">
      <div class="d-flex align-items-center mb-2">
        <img src="{% if m.company.image %}{{ m.company.image.url }}{% else %}{% static 'images/no-image.png' %}{% endif %}"
             alt="{{ m.company.company_name }}"
             class="me-2 rounded"
             style="width:40px; height:40px; object-fit:cover; border:1px solid #ddd;">
             <br>
        <div>

          <strong> {{ m.id }}.  {{ m.company.company_name|default:"-" }}</strong><br>  
          {% if m.meeting_date %}
            <span class="text-muted"> {{ m.meeting_date|date:"d M Y H:i" }}</span>
          {% endif %}
        </div>
      </div>
      <div>

        <strong> BC{{ m.company.id|default:"-" }}</strong>
        <strong>&nbsp;&nbsp;‚Äî&nbsp;&nbsp;{{ m.status|default:"-" }}</strong> 
      </div>
       

       <div class="border-top border-bottom py-2 mb-2">
        <strong>Address: </Address>:</strong> {{ m.company.address|default:"-" }}<br>
        <strong>Locality:</strong> {{ m.company.locality|default:"-" }}<br>
        <strong>City:</strong> {{ m.company.city|default:"-" }}<br>
        
      </div>
        <strong>Phone:</strong> <a href="tel:{{ m.company.contact_no }}">{{ m.company.contact_no|default:"-" }}  {{ m.company.contact_person|default:"-" }} </a>

      <div class="border-top border-bottom py-2 mb-2">
        {% if m.comment %}
          <strong>Comment:</strong> {{ m.comment }}<br>
        {% endif %}
        <strong>Assigned To:</strong>
        {% if m.assigned_to %}
          {{ m.assigned_to.user.get_full_name|default:m.assigned_to.user.username }}
        {% else %}
          -
        {% endif %}
        <br>
          <strong>Created:</strong> {{ m.create_at }} {{ m.created_by }}<br>
          <strong>Updated:</strong> {{ m.update_at }} {{ m.updated_by }}<br>

      </div>
      <div class="text-end">
        <a href="{% url 'edit_company_meeting' m.id %}" 
           class="btn btn-sm btn-outline-primary">
          <i class="fas fa-edit"></i> Edit
        </a>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="text-center text-muted">No meetings available.</div>
  {% endfor %}
</div>

<!-- PAGINATION -->
{% if is_paginated %}
<nav aria-label="Pagination" class="mt-3">
  <ul class="pagination justify-content-center flex-wrap">
    {% if page_obj.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo;</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
      {% elif num > page_obj.number|add:-2 and num < page_obj.number|add:2 %}
        <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">&raquo;</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<style>


  .jet-filter {
  position: relative;
}
.jet-input {
  width: 100%;
  padding: 6px 8px;
  border: 1px solid #d0d5dc;
  border-radius: 4px;
  font-size: 13px;
  background: #fff;
  transition: border 0.2s;
}
.jet-input:focus {
  outline: none;
  border-color: #58b3e7;
  box-shadow: 0 0 0 2px rgba(88, 179, 231, 0.2);
}
.jet-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 180px;
  overflow-y: auto;
  background: #fff;
  border: 1px solid #d0d5dc;
  border-top: none;
  display: none;
  z-index: 100;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}
.jet-option {
  padding: 6px 10px;
  cursor: pointer;
  font-size: 13px;
  color: #333;
}
.jet-option:hover {
  background: #e9f4fb;
}

</style>


{% endblock %}
