{% extends 'dashboard/base.html' %}
{% block title %}All Company Meetings{% endblock %}
{% load static %}
{% block content %}
<h4 class="mb-3">🏢 Company Meetings Filter</h4>

<form method="get" class="mb-4 bg-light p-3 rounded shadow-sm">
  <div class="row g-2 align-items-end">

    <div class="col-md-2 col-6">
      <label class="small fw-bold">From Date</label>
      <input type="date" name="date_from" class="form-control form-control-sm"
             value="{{ request.GET.date_from }}">
    </div>

    <div class="col-md-2 col-6">
      <label class="small fw-bold">To Date</label>
      <input type="date" name="date_to" class="form-control form-control-sm"
             value="{{ request.GET.date_to }}">
    </div>

    <div class="col-md-2 col-6">
      <label class="small fw-bold">City</label>
      <select name="city" class="form-control form-control-sm">
        <option value="">All</option>
        {% for c in cities %}
          <option value="{{ c.id }}" {% if request.GET.city == c.id|stringformat:'s' %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2 col-6">
      <label class="small fw-bold">Locality</label>
      <select name="locality" class="form-control form-control-sm">
        <option value="">All</option>
        {% for l in localities %}
          <option value="{{ l.id }}" {% if request.GET.locality == l.id|stringformat:'s' %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2 col-6">
      <label class="small fw-bold">Meeting Status</label>
      <select name="status" class="form-control form-control-sm">
        <option value="">All</option>
        {% for s in statuses %}
          <option value="{{ s }}" {% if request.GET.status == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2 col-6">
      <label class="small fw-bold">Assigned To</label>
      <select name="assigned_to" class="form-control form-control-sm">
        <option value="">All</option>
        {% for s in staff_list %}
          <option value="{{ s.id }}" {% if request.GET.assigned_to == s.id|stringformat:'s' %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2 col-6">
      <label class="small fw-bold">Category</label>
      <select name="category" class="form-control form-control-sm">
        <option value="">All</option>
        {% for c in categories %}
          <option value="{{ c.id }}" {% if request.GET.category == c.id|stringformat:'s' %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2 col-12 mt-2 mt-md-0">
      <button type="submit" class="btn btn-sm btn-primary w-100">
        <i class="fas fa-filter me-1"></i> Filter
      </button>
    </div>

    <div class="col-md-2 col-12 mt-2 mt-md-0">
      <a href="{% url 'company_meetings' %}" class="btn btn-sm btn-secondary w-100">
        <i class="fas fa-undo me-1"></i> Reset
      </a>
    </div>
  </div>
</form>


<h4 class="mb-3">🗓 All Meetings with Full Company Details</h4>

<div class="table-responsive d-none d-md-block">
  <table class="table table-bordered table-hover table-sm align-middle">
    <thead class="thead-dark">
      <tr>
        <th>ID</th>
        <th>Meeting Details</th>
        <th>Company Details</th>
        <th>Assigned To</th>
        <th>Created / Updated</th>
      </tr>
    </thead>
    <tbody>
      {% for m in meetings %}
      <tr>
        <td><strong>#{{ m.id }}</strong></td>

        <!-- 🗓 MEETING DETAILS -->
        <td style="min-width:250px;">
          <div class="small">
            <strong>Status:</strong> {{ m.status|default:"-" }}<br>
            {% if m.meeting_date %}
              <strong>Meeting Date:</strong> {{ m.meeting_date|date:"d M Y H:i" }}<br>
            {% endif %}
            {% if m.comment %}
              <strong>Comment:</strong> {{ m.comment|default:"-" }}<br>
            {% endif %}
          </div>
        </td>

        <!-- 🏢 COMPANY DETAILS -->
        <td style="min-width:350px;">
          <div class="border rounded bg-light p-2 small">
            <strong>Company ID:</strong> BC{{ m.company.id|stringformat:"03d" }}<br>
            <strong>Name:</strong> {{ m.company.company_name|default:"-" }}<br>
            <strong>Status:</strong> {{ m.company.status|default:"-" }}<br>
            <strong>Category:</strong> {{ m.company.category|default:"-" }}<br>
            <strong>Person:</strong> {{ m.company.contact_person|default:"-" }}<br>
            <strong>Phone:</strong> {{ m.company.contact_no|default:"-" }}<br>
            <strong>City:</strong> {{ m.company.city|default:"-" }}<br>
            <strong>Locality:</strong> {{ m.company.locality|default:"-" }}<br>
            <strong>Address:</strong> {{ m.company.address|default:"-" }}<br>
            <strong>Assigned:</strong> {{ m.company.assigned_to|default:"-" }}<br>
            <strong>Created By:</strong> {{ m.company.created_by|default:"-" }}<br>
            <strong>Created On:</strong> {{ m.company.create_at|date:"d M Y H:i" }}
          </div>
        </td>

        <!-- 👤 ASSIGNED -->
        <td>
          {% if m.assigned_to %}
            {{ m.assigned_to }}
          {% else %}
            -
          {% endif %}
        </td>

        <!-- 🕓 CREATED / UPDATED -->
        <td class="small text-muted">
          {% if m.created_by %}
            <strong>{{ m.created_by }}</strong><br>
            <span>{{ m.create_at|date:"d M Y H:i" }}</span><br>
          {% endif %}
          {% if m.updated_by %}
            <strong>{{ m.updated_by }}</strong><br>
            <span>{{ m.update_at|date:"d M Y H:i" }}</span>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" class="text-center text-muted">No meetings found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- 📱 MOBILE CARD VIEW (Responsive Fixed) -->
<div class="d-md-none">
  {% for m in meetings %}
  <div class="card mb-3 shadow-sm border-0 rounded-3" style="background:#f9f9f9;">

    
    <div class="card-body p-3 small">
      <h6 class="fw-bold mb-2">
        🏢 #{{ m.id }} — {{ m.company.company_name|default:"Unnamed Company" }}
      </h6>

      <div class="mb-2 border-bottom pb-2">
        <strong>Status:</strong> {{ m.status|default:"-" }}<br>
        {% if m.meeting_date %}
          <strong>Meeting Date:</strong> {{ m.meeting_date|date:"d M Y H:i" }}<br>
        {% endif %}
        {% if m.comment %}
          <strong>Comment:</strong> {{ m.comment }}<br>
        {% endif %}
        <strong>Assigned To:</strong>
        {% if m.assigned_to %}
          {{ m.assigned_to.user.get_full_name|default:m.assigned_to.user.username }}
        {% else %}
          -
        {% endif %}
      </div>

      <div class="mb-2 border-bottom pb-2">
        <strong>Company ID:</strong> BC{{ m.company.id|stringformat:"03d" }}<br>
        <strong>Status:</strong> {{ m.company.status|default:"-" }}<br>
        <strong>Category:</strong> {{ m.company.category|default:"-" }}<br>
        <strong>Person:</strong> {{ m.company.contact_person|default:"-" }}<br>
        <strong>Phone:</strong> <a href="tel:{{ m.company.contact_no }}">{{ m.company.contact_no|default:"-" }}</a><br>
        <strong>City:</strong> {{ m.company.city|default:"-" }}<br>
        <strong>Locality:</strong> {{ m.company.locality|default:"-" }}<br>
        <strong>Address:</strong> {{ m.company.address|default:"-" }}<br>
      </div>

      <div>
        <strong>Created By:</strong> {{ m.company.created_by|default:"-" }}<br>
        <strong>Created On:</strong> {{ m.company.create_at|date:"d M Y H:i" }}<br>
        {% if m.updated_by %}
          <strong>Updated By:</strong> {{ m.updated_by|default:"-" }}<br>
          <strong>Updated On:</strong> {{ m.update_at|date:"d M Y H:i" }}
        {% endif %}
      </div>
    </div>
  </div>
  {% empty %}
  <div class="text-center text-muted">No meetings available.</div>
  {% endfor %}
</div>

{% if is_paginated %}
<nav aria-label="Pagination" class="mt-3">
  <ul class="pagination justify-content-center flex-wrap">
    {% if page_obj.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo;</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
    {% endif %}
    {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
      {% elif num > page_obj.number|add:-2 and num < page_obj.number|add:2 %}
        <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
      {% endif %}
    {% endfor %}
    {% if page_obj.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">&raquo;</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}
{% endblock %}
