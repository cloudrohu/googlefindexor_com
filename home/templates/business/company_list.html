{% extends 'dashboard/base.html' %}
{% block title %}All Companies{% endblock %}
{% load static %}
{% block content %}

<!-- ðŸ” FILTER BAR -->
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3">

  <!-- ðŸ”¹ Title with Count -->
  <h4 class="mb-2 d-flex align-items-center" style="gap:8px;">
    <span>All Companies</span>
    <span class="text-muted">â€”</span>
    <span class="badge bg-primary" style="font-size:0.9rem;">
      {{ page_obj.paginator.count }}
    </span>
  </h4>

  <!-- ðŸ”¹ Filters -->
  <form method="get" class="d-flex flex-wrap align-items-center gap-2">
    <!-- Category -->
    <select name="category" class="form-select form-select-sm" style="min-width:130px;">
      <option value="">All Categories</option>
      {% for cat in categories %}
        <option value="{{ cat.id }}" {% if request.GET.category == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.title }}</option>
      {% endfor %}
    </select>

    <!-- Status -->
    <select name="status" class="form-select form-select-sm" style="min-width:130px;">
      <option value="">All Status</option>
      {% if companies %}
        {% for key, label in companies.first.STATUS_CHOICES %}
          <option value="{{ key }}" {% if request.GET.status == key %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      {% endif %}
    </select>

   <!-- City -->
<select name="city" class="form-select form-select-sm" style="min-width:130px;">
  <option value="">All Cities</option>
  {% for city in cities %}
    <option value="{{ city.id }}" {% if request.GET.city == city.id|stringformat:"s" %}selected{% endif %}>
      {{ city.title|default_if_none:"" }}
    </option>
  {% endfor %}
</select>

<!-- Locality -->
<select name="locality" class="form-select form-select-sm" style="min-width:130px;">
  <option value="">All Localities</option>
  {% for loc in localities %}
    <option value="{{ loc.id }}" {% if request.GET.locality == loc.id|stringformat:"s" %}selected{% endif %}>
      {{ loc.title|default_if_none:"" }}
    </option>
  {% endfor %}
</select>


    <!-- Created By -->
    <select name="created_by" class="form-select form-select-sm" style="min-width:130px;">
      <option value="">All Users</option>
      {% for user in users %}
        <option value="{{ user.id }}" {% if request.GET.created_by == user.id|stringformat:"s" %}selected{% endif %}>{{ user.username }}</option>
      {% endfor %}
    </select>

    <!-- Follow-up Date Range -->
    <input type="date" name="followup_from" value="{{ request.GET.followup_from }}" class="form-control form-control-sm" style="min-width:140px;">
    <input type="date" name="followup_to" value="{{ request.GET.followup_to }}" class="form-control form-control-sm" style="min-width:140px;">

    <!-- Buttons -->
    <button type="submit" class="btn btn-sm btn-primary">Filter</button>
    <a href="{% url 'company_list' %}" class="btn btn-sm btn-secondary">Reset</a>
  </form>
</div>


<h4 class="mb-3 d-flex align-items-center">
  All Companies&nbsp;&nbsp;â€”&nbsp;&nbsp;
  <span class="badge bg-primary" style="font-size:0.9rem; padding:0.4em 0.7em;">
    {{ page_obj.paginator.count }}
  </span>
</h4>

<!-- ðŸ–¥ DESKTOP TABLE -->
<div class="table-responsive d-none d-md-block">
  <table class="table table-bordered table-hover table-sm align-middle">
    <thead class="thead-dark">
      <tr>
        <th>ID</th>
        <th>Company</th>
        <th>Category</th>
        <th>Person</th>
        <th>Phone</th>
        <th>Status</th>
        <th>Locality</th>
        <th>Address</th>
        <th>Follow-up / Meeting</th>
        <th>Created By</th>
        <th>Updated By</th>
        <th>Created</th>
        <th>Updated</th>
        <th style="min-width:300px;">Comments / Voice</th>
      </tr>
    </thead>
    <tbody>
      {% for c in companies %}
      <tr>
        <td>CO{{ c.id|stringformat:"03d" }}</td>

        <!-- ðŸ–¼ Company Thumbnail + Name -->
        <td>
          <div class="d-flex align-items-center">
            <img src="{% if c.image %}{{ c.image.url }}{% else %}{% static 'images/no-image.png' %}{% endif %}"
                 alt="{{ c.company_name }}"
                 class="mr-2 rounded"
                 style="width:40px; height:40px; object-fit:cover; border:1px solid #ddd;">
            <span>{{ c.company_name|default:"-" }}</span>
          </div>
        </td>

        <!-- ðŸ· Category -->
        <td>{{ c.category.title|default:"-" }}</td>

        <!-- ðŸ‘¤ Contact Person -->
        <td>{{ c.contact_person|default:"-" }}</td>

        <!-- ðŸ“ž Phone -->
        <td>{{ c.contact_no|default:"-" }}</td>

        <!-- âš¡ STATUS -->
        <td>
          <select class="form-control form-control-sm status-select" data-id="{{ c.id }}">
            {% for key, label in c.STATUS_CHOICES %}
              <option value="{{ key }}" {% if c.status == key %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </td>

        <!-- ðŸ“ Locality -->
        <td>{{ c.locality|default:"-" }}</td>

        <!-- ðŸ  Address -->
        <td class="text-muted small">{{ c.address|default:"-" }}</td>

        <!-- ðŸ“… Follow-up / Meeting -->
        <td>
          {% if c.followup_meeting %}
            {{ c.followup_meeting|date:"d M Y H:i" }}
          {% else %}
            <span class="text-muted small">No schedule</span>
          {% endif %}
        </td>

        <!-- ðŸ‘©â€ðŸ’¼ Created & Updated -->
        <td>{{ c.created_by|default:"-" }}</td>
        <td>{{ c.updated_by|default:"-" }}</td>

        <!-- ðŸ•’ Dates -->
        <td>{{ c.create_at|date:"d M Y H:i" }}</td>
        <td>{{ c.update_at|date:"d M Y H:i" }}</td>

        <!-- ðŸ’¬ Comments / Voice -->
        <td>
          {% with latest_comment=c.comments.last %}
          {% if latest_comment %}
            <div class="small text-muted border-bottom py-1">
              <strong>{{ latest_comment.created_by }}</strong>
              <span class="text-secondary ml-1" style="font-size:11px;">
                {{ latest_comment.create_at|date:"d M Y H:i" }}
              </span>: {{ latest_comment.comment }}
            </div>
          {% else %}
            <div class="text-muted small">No comments yet.</div>
          {% endif %}
          {% endwith %}

          <!-- âž• Add Comment -->
          <form class="commentForm mt-1" data-id="{{ c.id }}">
            {% csrf_token %}
            <div class="input-group input-group-sm">
              <input type="text" name="comment" class="form-control" placeholder="Add comment...">
              <div class="input-group-append">
                <button class="btn btn-primary btn-sm" type="submit">âž•</button>
              </div>
            </div>
          </form>

          <!-- ðŸŽ¤ Voice -->
          <div id="voiceList{{ c.id }}" class="mt-1">
            {% with latest_voice=c.voice_recordings.last %}
              {% if latest_voice %}
              <div class="mb-1" id="latest-voice-{{ c.id }}">
                  <audio controls preload="none" class="w-100">
                    <source src="{{ latest_voice.file.url }}" type="audio/mpeg">
                  </audio>
                  <div class="text-muted small">
                    {{ latest_voice.uploaded_at|date:"d M Y H:i" }} â€” {{ latest_voice.uploaded_by|default:"User" }}
                  </div>
              </div>
              {% else %}
              <div class="text-muted small">No voice yet.</div>
              {% endif %}
            {% endwith %}
          </div>

          <!-- ðŸ“¤ Upload Voice -->
          <form class="voiceForm mt-1" data-id="{{ c.id }}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="input-group input-group-sm">
              <input type="file" name="file" accept="audio/*" class="form-control p-1">
              <div class="input-group-append">
                <button class="btn btn-success btn-sm" type="submit">ðŸŽ¤</button>
              </div>
            </div>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ðŸ“± MOBILE CARD VIEW (FULL VERSION WITH ALL FIELDS) -->
<div class="d-md-none">
  {% for c in companies %}
  <div class="card mb-3 shadow-sm border-0" style="border-left: 4px solid #007bff;">
    <div class="card-body p-2">

      <!-- ðŸ–¼ Company Thumbnail + Name -->
      <div class="d-flex align-items-center mb-2">
        <img src="{% if c.image %}{{ c.image.url }}{% else %}{% static 'images/no-image.png' %}{% endif %}"
             alt="{{ c.company_name }}"
             class="mr-2 rounded"
             style="width:40px; height:40px; object-fit:cover; border:1px solid #ddd;">
        <div>
          <strong>{{ c.company_name|default:"-" }}</strong><br>
          <span class="text-muted small">{{ c.locality|default:"-" }}, {{ c.city|default:"-" }}</span>
        </div>
      </div>
      <!-- ðŸ“‹ DETAILS -->
      <div class="small text-muted mb-2">
        <div><strong>Category:</strong> {{ c.category.title|default:"-" }}</div>
      </div>  
      <!-- âš¡ STATUS -->
      <div class="d-flex justify-content-between mb-2">
        <strong>CO{{ c.id|stringformat:"03d" }}</strong>
        <select class="form-control form-control-sm status-select" data-id="{{ c.id }}">
          {% for key, label in c.STATUS_CHOICES %}
            <option value="{{ key }}" {% if c.status == key %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      
          <span class="text-muted small">{{ c.address|default:"-" }}</span>

      <br><br>
      <!-- ðŸ“‹ DETAILS -->
      <div class="small text-muted mb-2">
        <div><strong>Person:</strong> {{ c.contact_person|default:"-" }}</div>
        <div><strong>Phone:</strong> {{ c.contact_no|default:"-" }}</div>

        <div><strong>Follow-up:</strong>
          {% if c.followup_meeting %}
            {{ c.followup_meeting|date:"d M Y H:i" }}
          {% else %}
            <span class="text-muted small">No schedule</span>
          {% endif %}
        </div>

        <hr class="my-1">

        <div><strong>Created:</strong> {{ c.create_at|date:"d M Y H:i" }}/{{ c.created_by|default:"-" }} </div>
        <div><strong>Updated:</strong> {{ c.update_at|date:"d M Y H:i" }}/{{ c.updated_by|default:"-" }}</div>
      </div>

      <!-- ðŸ’¬ COMMENTS -->
      <div id="commentList{{ c.id }}_mobile" class="mt-2">
        {% for comment in c.comments.all %}
        <div class="small text-muted border-bottom py-1">
          <strong>{{ comment.created_by }}</strong>
          <span class="text-secondary ml-1" style="font-size:11px;">
            {{ comment.create_at|date:"d M Y H:i" }}
          </span>: {{ comment.comment }}
        </div>
        {% empty %}
        <div class="text-muted small">No comments yet.</div>
        {% endfor %}
      </div>

      <!-- âž• ADD COMMENT -->
      <form class="commentForm mt-1" data-id="{{ c.id }}">
        {% csrf_token %}
        <div class="input-group input-group-sm">
          <input type="text" name="comment" class="form-control" placeholder="Add comment...">
          <div class="input-group-append">
            <button class="btn btn-primary btn-sm" type="submit">âž•</button>
          </div>
        </div>
      </form>

      <!-- ðŸŽ¤ VOICE SECTION -->
      <div id="voiceList{{ c.id }}" class="mt-2">
        {% with latest_voice=c.voice_recordings.last %}
          {% if latest_voice %}
            <div class="mb-1" id="latest-voice-{{ c.id }}">
              <audio controls preload="none" class="w-100">
                <source src="{{ latest_voice.file.url }}" type="audio/mpeg">
              </audio>
              <div class="text-muted small">
                {{ latest_voice.uploaded_at|date:"d M Y H:i" }} â€” {{ latest_voice.uploaded_by|default:"User" }}
              </div>
            </div>
          {% else %}
            <div class="text-muted small">No voice yet.</div>
          {% endif %}
        {% endwith %}
      </div>

      <!-- ðŸ“¤ UPLOAD VOICE -->
      <form class="voiceForm mt-1" data-id="{{ c.id }}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="input-group input-group-sm">
          <input type="file" name="file" accept="audio/*" class="form-control p-1">
          <div class="input-group-append">
            <button class="btn btn-success btn-sm" type="submit">ðŸŽ¤</button>
          </div>
        </div>
      </form>

    </div>
  </div>
  {% endfor %}
</div>




{% if is_paginated %}
<nav aria-label="Page navigation" class="mt-3">
  <ul class="pagination justify-content-center flex-wrap flex-md-nowrap overflow-auto" style="white-space: nowrap;">
    {% if page_obj.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">&laquo;</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
    {% endif %}

    {% for i in page_obj.paginator.page_range %}
      {% if i >= page_obj.number|add:"-2" and i <= page_obj.number|add:"2" %}
        {% if page_obj.number == i %}
          <li class="page-item active"><span class="page-link">{{ i }}</span></li>
        {% else %}
          <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
        {% endif %}
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">&raquo;</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

{% endblock %}
